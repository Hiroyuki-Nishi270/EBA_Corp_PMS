<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <style>
		body {
			font-family: sans-serif;
			background: #ccc;
		}
		.container {
			width: 80%;
			margin: 0 auto;
		}
		/* custom class */
		.gantt .bar-milestone .bar {
			fill: tomato;
		}
		.heading {
			text-align: center;
		}
	</style>
    <link rel="stylesheet" th:href="@{/css/frappe-gantt.css}" />
    <script th:src="@{/js/frappe-gantt.js}"></script>
</head>
<body>
<H1>EBA Corp Project Management System</H1>
<!--ログアウト-->
<form class="form-signin" method="post" th:action="@{/logout}">
  <button id="logout-button" class="btn btn-lg btn-primary btn-block" type="submit">Log Out</button>
</form>

<!--タスクリスト -->
<div class="container">
<h2 class="heading">タスクリスト</h2>
<table>
    <thead>
        <tr>
            <th>id</th>
            <th>タスク名</th>
            <th>進捗</th>
            <th>開始日</th>
            <th>終了日</th>
        </tr>
    </thead>
    <tbody>
        <tr th:each="task : ${taskList}">
            <td th:text="${task.id}"></td>
            <td><a th:href="@{'/ticket/' + ${task.id}}" th:text="${task.name}"></a></td>
            <td th:text="${task.progress} + '%'"></td>
            <td th:text="${task.start}"></td>
            <td th:text="${task.end}"></td>
        </tr>
    </tbody>
</table>
    <a th:href="@{/ticket/new}" id="newtask">新しいタスクを作成</a>
</div>
<!--ガントチャート-->
<div class="container">
    <h2 class="heading">ガントチャート</h2>
    <div id="view_mode_buttons" class="mx-auto mt-3 btn-group" role="group">
        <button id="view_mode_d" type="button" class="btn btn-sm btn-light">Day</button>
        <button id="view_mode_w" type="button" class="btn btn-sm btn-light">Week</button>
        <button id="view_mode_m" type="button" class="btn btn-sm btn-light">Month</button>
    </div>
    <!-- Gantt Chart本体-->
    <div class="gantt-target"></div>
    <button id="resetGantt" type="reset" class="btn btn-sm btn-light">Reset</button>
</div>
<input type="hidden" id="task0start" value="2018-10-01 0:00:00">
<script th:inline="javascript">
    let ganttTaskList = /*[[${ganttTaskList}]]*/ null;

    		let gantt_chart = new Gantt(".gantt-target", ganttTaskList, {
			on_click: task => {
				console.log(task);
			},
			on_date_change: (task, start, end) => {
				console.log(task, start, end);
				console.log(`${task.id} moving`);
				if(task.id == 'Task 0'){
					let task0start = document.querySelector('#task0start');
					task0start.value = `${start.getFullYear()}-${start.getMonth()+1}-${start.getDate()} 00:00:00}`;
				}
				console.log(`${task.id} moved`);
			},
			on_progress_change: (task, progress) => {
				console.log(task, progress);
			},
			on_view_change: (mode) => {
				console.log(mode);
			},
			date_format: 'YYYY-MM-DD',
			view_mode: 'Month',
			language: 'ja-JP',
			custom_popup_html: function(task) {
	  			// the task object will contain the updated
	  			// dates and progress value .format('MMM D')
				console.log(task);
				//console.log(`start:(${typeof(task.start)})${task.start},end:(${typeof(task.end)})${task.end}`);
				//console.log(`_start:(${typeof(task._start)})${task._start},_end:(${typeof(task._end)})${task._end}`);



	 			const end_date = `${task._end.getMonth() + 1}月${task._end.getDate()}日`;

	 			//

	  			return `
					<div class="details-container">
	  					<h5>${task.name}</h5>
	  					<p>期限: ${end_date}</p>
	  					<p>${task.progress}% 完了</p>
					</div>
 				 `;
 				 //console.log(task._end);
			}
		});
		console.log(gantt_chart);

	/**
	let qd = document.querySelector('#view_mode_qd');
	qd.addEventListener('click',function(){
		gantt_chart.change_view_mode('Quarter Day')
		console.log(qd.textContent);
	},false);

	let hd = document.querySelector('#view_mode_hd');
	hd.addEventListener('click',function(){
		gantt_chart.change_view_mode('Half Day')
		console.log(hd.textContent);
	},false);

**/
	let vmd = document.querySelector('#view_mode_d');
	vmd.addEventListener('click',function(){
		gantt_chart.change_view_mode('Day')
		//console.log(vmd.textContent);
	},false);

	let vmw = document.querySelector('#view_mode_w');
	vmw.addEventListener('click',function(){
		gantt_chart.change_view_mode('Week')
		console.log(vmw.textContent);
	},false);

	let vmm = document.querySelector('#view_mode_m');
	vmm.addEventListener('click',function(){
		gantt_chart.change_view_mode('Month')
		console.log(vmm.textContent);
	},false);

	let rg = document.querySelector('#resetGantt');
	rg.addEventListener('click',function(){
		gantt_chart.refresh(tasks);
		console.log('reset');
		console.log(tasks);
	},false);
</script>

</body>
</html>